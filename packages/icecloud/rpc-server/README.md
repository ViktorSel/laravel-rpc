## Процедура

В контексте сервера процедурой является класс, который инкапсулирует бизнес логику, 
описание аргументов процедуры и её результата.

Конечной процедурой может быть класс, унаследованный от абстрактного класса 
```IceCloud\RpcServer\Lib\Procedure``` который требует определить следующие 
методы:

- ```argumentsSchema``` - описывает аргументы процедуры
- ```resultSchema``` - описывает результат процедуры
- ```description``` - текстовое описание процедуры
- ```hasDetailedValidationErrors``` - сообщает, нужно ли формировать расширенный ответ в случае ошибок валидации
- ```name``` - определяет имя процедуры, по которому она может быть вызвана клиентом
- ```handle``` - обработчик бизнес логики

Также могут быть переопределены методы:

- ```middlewares``` - стек middlewares, который требуется процедуре
- ```boot``` - бут функция, которую сервер вызывает после проверки на конфликты имён

Сервер создает экземпляр класса, автоматически проверяет переданные аргументы, 
используя описание, определенное в методе ```argumentsSchema``` и 
вызывает метод ```handle```.

### Построение схем описания

Сервер использует абстракцию входных и выходных 
параметров процедуры. Эта абстракция используются для 
компиляции правил валидации входных параметров, генерации 
swagger конструкций, а также для автоматической генерации клиента.

Типичный пример процедуры ```MyService.V1.AddBook```:

```php
use IceCloud\RpcServer\Lib\Procedure;
use IceCloud\RpcServer\Lib\Schema\ResultSchema;
use IceCloud\RpcServer\Lib\Schema\ArgumentsSchema;
use IceCloud\RpcClient\Lib\RpcRequest;

class AddBook extends Procedure {
    
    public function name() : string
    {
        return "MyService.V1.AddBook";
    }
    public function description() : string
    {
        return "Добавить книгу";
    }
    public function hasDetailedValidationErrors() : bool
    {
        return true; // Ошибки будут перечислены в структуре "data" объекта "error"
    }
    public function argumentsSchema(ArgumentsSchema $schema)
    {
        $schema->string("title")
            ->required("Название не может быть пустым")
            ->min(2, "Не менее 2-х символов")
            ->max(255, "Не более 255 символов");
             
        $schema->float("price")
            ->required("Цена должна быть указана")
            ->min(0.01, "Не может быть дешевле одной копейки");
    }
    public function resultSchema(ResultSchema $schema)
    {
        $schema->bool()->comment("Статус выполнения");
    }
    public function handle(RpcRequest $request)
    {
        // Какой-то код для выполнения
    }
}
```

Как видно из примера, описание позволяет автоматизировать валидацию, и 
генерацию документации одной абстракцией. 

### Кеширование схем описания

Сервер кеширует скомпилированные данные для валидации и значений 
по умолчанию в php файлы. Путь для кешей конфигурируется параметром 
```schemaCachePath``` в конфиге сервера. 

Имя кеша для процедуры совпадает с именем процедуры. Если кеш удалить или 
удалить всю папку - кеш будет пересоздан автоматически при вызовах процедур.

Также, кеш сбрасывается автоматически в случае если дата записи php файла с процедурой
старше, чем дата записи кеша.

_Вариант кеширования в php файлы выбран неслучайно — скорость работы такого кеша
в 6 раз превышает Redis. Кроме того, позволяет наиболее простым способом
увидеть результат компиляции схемы._

### Установка сервера

Сервер вешается на произвольный action

Требования:
1. action должен быть исключен из проверки csrf
2. URI должен соответствовать паттерну ```/rpc-<сервис>```
3. Структура папок, где располагаются процедуры и middlewares должна соответствовать
   ```<app>/Rpc/Procedures``` и ```<app>/Rpc/Middlewares``` соответственно

Типичный код подключения

```php
use IceCloud\RpcServer\Lib\Server;
use Illuminate\Http\JsonResponse;

$server = (new Server)
    ->load(); // Загружает процедуры из папки (конфиг rpc-server.proceduresPath)
$response = $server->handle(
    request()
);
return $response !== null 
    ? new JsonResponse($response)
    : null;
```

### Консольные команды

```rpc:make:procedure {name}``` - создать процедуру, в аргументе нужно указать полное квалификационное имя процедуры, например ```<сервис>.v<версия>.<процедура>```
